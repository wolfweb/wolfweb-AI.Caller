@using AI.Caller.Phone.Entities
@model IEnumerable<SipAccount>

@{
    ViewData["Title"] = "SIP账户管理";
}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-telephone"></i> SIP账户管理</h2>
            <p class="text-muted">管理系统中的SIP账户</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSipAccountModal">
                <i class="bi bi-plus-circle"></i> 添加SIP账户
            </button>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">SIP账户列表</h5>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchSipAccounts" class="form-control" placeholder="搜索SIP账户...">
                    </div>
                </div>
            </div>
        </div>
        
        @if (Model == null || !Model.Any())
        {
            <div class="card-body text-center py-5">
                <i class="bi bi-telephone fs-1 text-muted"></i>
                <h4 class="mt-3">暂无SIP账户</h4>
                <p class="text-muted">系统中还没有添加任何SIP账户</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSipAccountModal">
                    <i class="bi bi-plus-circle"></i> 添加第一个SIP账户
                </button>
            </div>
        }
        else
        {
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="sipAccountsTable">
                        <thead class="table-light">
                            <tr>
                                <th>SIP用户名</th>
                                <th>SIP服务器</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>使用用户数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var sipAccount in Model)
                            {
                                <tr class="sip-account-row">
                                    <td>
                                        <i class="bi bi-telephone-fill text-primary me-2"></i>
                                        @sipAccount.SipUsername
                                    </td>
                                    <td>@sipAccount.SipServer</td>
                                    <td>
                                        @if (sipAccount.IsActive)
                                        {
                                            <span class="badge bg-success">激活</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">禁用</span>
                                        }
                                    </td>
                                    <td>@sipAccount.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>
                                        <span class="badge bg-info">@sipAccount.Users.Count</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary edit-sip-btn" 
                                                    data-id="@sipAccount.Id"
                                                    data-username="@sipAccount.SipUsername"
                                                    data-server="@sipAccount.SipServer"
                                                    data-active="@sipAccount.IsActive"
                                                    title="编辑">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            @if (sipAccount.Users.Count == 0)
                                            {
                                                <button class="btn btn-outline-danger delete-sip-btn" 
                                                        data-id="@sipAccount.Id"
                                                        data-username="@sipAccount.SipUsername"
                                                        title="删除">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-outline-secondary" 
                                                        title="该账户已被使用，无法删除" disabled>
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        共 @Model.Count() 个SIP账户
                    </div>
                    <div>
                        <nav>
                            <ul class="pagination mb-0">
                                <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item disabled"><a class="page-link" href="#">下一页</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- 添加SIP账户模态框 -->
<div class="modal fade" id="addSipAccountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加SIP账户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSipAccountForm">
                    <div class="mb-3">
                        <label for="addSipUsername" class="form-label">SIP用户名</label>
                        <input type="text" class="form-control" id="addSipUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="addSipPassword" class="form-label">SIP密码</label>
                        <input type="password" class="form-control" id="addSipPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="addSipServer" class="form-label">SIP服务器</label>
                        <input type="text" class="form-control" id="addSipServer" required>
                        <div class="form-text">例如: sip.example.com:5060</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="addIsActive" checked>
                            <label class="form-check-label" for="addIsActive">
                                激活账户
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveAddSipAccountBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑SIP账户模态框 -->
<div class="modal fade" id="editSipAccountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑SIP账户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSipAccountForm">
                    <input type="hidden" id="editSipAccountId">
                    <div class="mb-3">
                        <label for="editSipUsername" class="form-label">SIP用户名</label>
                        <input type="text" class="form-control" id="editSipUsername" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editSipPassword" class="form-label">新密码</label>
                        <input type="password" class="form-control" id="editSipPassword">
                        <div class="form-text">留空表示不更改密码</div>
                    </div>
                    <div class="mb-3">
                        <label for="editSipServer" class="form-label">SIP服务器</label>
                        <input type="text" class="form-control" id="editSipServer" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsActive">
                            <label class="form-check-label" for="editIsActive">
                                激活账户
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveEditSipAccountBtn">保存</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 搜索功能
            const searchInput = document.getElementById('searchSipAccounts');
            const sipAccountRows = document.querySelectorAll('.sip-account-row');
            
            searchInput.addEventListener('keyup', function() {
                const searchTerm = this.value.toLowerCase();
                
                sipAccountRows.forEach(row => {
                    const username = row.querySelector('td:first-child').textContent.toLowerCase();
                    const server = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    
                    if (username.includes(searchTerm) || server.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
            
            // 添加SIP账户按钮
            document.getElementById('saveAddSipAccountBtn').addEventListener('click', async function() {
                const username = document.getElementById('addSipUsername').value;
                const password = document.getElementById('addSipPassword').value;
                const server = document.getElementById('addSipServer').value;
                const isActive = document.getElementById('addIsActive').checked;
                
                if (!username || !password || !server) {
                    alert('SIP用户名、密码和服务器是必填项');
                    return;
                }
                
                try {
                    const response = await fetch('/Account/AddSipAccount', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sipUsername: username,
                            sipPassword: password,
                            sipServer: server,
                            isActive: isActive
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('SIP账户添加成功');
                        location.reload();
                    } else {
                        alert('添加失败: ' + result.message);
                    }
                } catch (error) {
                    alert('添加失败: ' + error.message);
                }
            });
            
            // 编辑SIP账户按钮
            document.querySelectorAll('.edit-sip-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const username = this.dataset.username;
                    const server = this.dataset.server;
                    const isActive = this.dataset.active === 'True';
                    
                    document.getElementById('editSipAccountId').value = id;
                    document.getElementById('editSipUsername').value = username;
                    document.getElementById('editSipServer').value = server;
                    document.getElementById('editIsActive').checked = isActive;
                    
                    const editModal = new bootstrap.Modal(document.getElementById('editSipAccountModal'));
                    editModal.show();
                });
            });
            
            // 保存编辑SIP账户
            document.getElementById('saveEditSipAccountBtn').addEventListener('click', async function() {
                const id = document.getElementById('editSipAccountId').value;
                const password = document.getElementById('editSipPassword').value;
                const server = document.getElementById('editSipServer').value;
                const isActive = document.getElementById('editIsActive').checked;
                
                try {
                    const response = await fetch('/Account/EditSipAccount', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: id,
                            sipPassword: password,
                            sipServer: server,
                            isActive: isActive
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('SIP账户更新成功');
                        location.reload();
                    } else {
                        alert('更新失败: ' + result.message);
                    }
                } catch (error) {
                    alert('更新失败: ' + error.message);
                }
            });
            
            // 删除SIP账户按钮
            document.querySelectorAll('.delete-sip-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const id = this.dataset.id;
                    const username = this.dataset.username;
                    
                    if (confirm(`确定要删除SIP账户 "${username}" 吗？此操作不可恢复。`)) {
                        try {
                            const response = await fetch(`/Account/DeleteSipAccount/${id}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                alert('SIP账户删除成功');
                                location.reload();
                            } else {
                                alert('删除失败: ' + result.message);
                            }
                        } catch (error) {
                            alert('删除失败: ' + error.message);
                        }
                    }
                });
            });
        });
    </script>
}
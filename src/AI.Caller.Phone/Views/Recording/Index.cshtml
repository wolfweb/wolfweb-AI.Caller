@model AI.Caller.Phone.Models.PagedResult<AI.Caller.Phone.Entities.CallRecording>
@using AI.Caller.Phone.Entities
@using AI.Caller.Phone.Models
@using Microsoft.AspNetCore.Routing

@{
    ViewData["Title"] = "通话录音管理";
    var filter = ViewBag.Filter as RecordingFilter;
    var storageInfo = ViewBag.StorageInfo as StorageInfo;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">通话录音管理</h3>
                    <div class="card-tools">
                        <a asp-action="Settings" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-cog"></i> 设置
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshRecordings()">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                    </div>
                </div>

                <!-- 存储信息 -->
                @if (storageInfo != null)
                {
                    <div class="card-body border-bottom">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-info"><i class="fas fa-hdd"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">存储使用</span>
                                        <span class="info-box-number">@(storageInfo.UsedSizeMB) / @(storageInfo.TotalSizeMB) MB</span>
                                        <div class="progress">
                                            <div class="progress-bar" style="width: @(storageInfo.UsagePercentage)%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-success"><i class="fas fa-microphone"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">录音总数</span>
                                        <span class="info-box-number">@storageInfo.RecordingCount</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- 搜索过滤器 -->
                <div class="card-body border-bottom">
                    <form id="filterForm" method="get">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>开始日期</label>
                                    <input type="date" class="form-control" name="StartDate" value="@filter?.StartDate?.ToString("yyyy-MM-dd")" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>结束日期</label>
                                    <input type="date" class="form-control" name="EndDate" value="@filter?.EndDate?.ToString("yyyy-MM-dd")" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>主叫号码</label>
                                    <input type="text" class="form-control" name="CallerNumber" value="@filter?.CallerNumber" placeholder="主叫号码" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>被叫号码</label>
                                    <input type="text" class="form-control" name="CalleeNumber" value="@filter?.CalleeNumber" placeholder="被叫号码" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search"></i> 搜索
                                        </button>
                                        <a href="@Url.Action("Index")" class="btn btn-secondary">
                                            <i class="fas fa-times"></i> 清除
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- 录音列表 -->
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>通话时间</th>
                                    <th>主叫号码</th>
                                    <th>被叫号码</th>
                                    <th>时长</th>
                                    <th>文件大小</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Items.Any())
                                {
                                    @foreach (var recording in Model.Items)
                                    {
                                        <tr>
                                            <td>@recording.StartTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                            <td>@recording.CallerNumber</td>
                                            <td>@recording.CalleeNumber</td>
                                            <td>
                                                @if (recording.Duration != TimeSpan.Zero)
                                                {
                                                    @recording.Duration.ToString(@"hh\:mm\:ss")
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                @if (recording.FileSize > 0)
                                                {
                                                    @((recording.FileSize / 1024.0 / 1024.0).ToString("F2")) @("MB")
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                @switch (recording.Status)
                                                {
                                                    case RecordStatus.Recording:
                                                        <span class="badge badge-warning">录音中</span>
                                                        break;
                                                    case RecordStatus.Completed:
                                                        <span class="badge badge-success">已完成</span>
                                                        break;
                                                    case RecordStatus.Failed:
                                                        <span class="badge badge-danger">失败</span>
                                                        break;
                                                    default:
                                                        <span class="badge badge-secondary">未知</span>
                                                        break;
                                                }
                                            </td>
                                            <td>
                                                @if (recording.Status == RecordStatus.Completed)
                                                {
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="playRecording(@recording.Id)" title="播放">
                                                            <i class="fas fa-play"></i>
                                                        </button>
                                                        <a href="@Url.Action("Download", new { id = recording.Id })" class="btn btn-sm btn-outline-success" title="下载">
                                                            <i class="fas fa-download"></i>
                                                        </a>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteRecording(@recording.Id)" title="删除">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">无操作</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">暂无录音记录</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- 分页 -->
                    @if (Model.TotalPages > 1)
                    {
                        <nav aria-label="录音分页">
                            <ul class="pagination justify-content-center">
                                @if (Model.HasPreviousPage)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@GetPageUrl(Model.Page - 1)">上一页</a>
                                    </li>
                                }

                                @for (int i = Math.Max(1, Model.Page - 2); i <= Math.Min(Model.TotalPages, Model.Page + 2); i++)
                                {
                                    <li class="page-item @(i == Model.Page ? "active" : "")">
                                        <a class="page-link" href="@GetPageUrl(i)">@i</a>
                                    </li>
                                }

                                @if (Model.HasNextPage)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@GetPageUrl(Model.Page + 1)">下一页</a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 播放模态框 -->
<div class="modal fade" id="playModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">播放录音</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <audio id="audioPlayer" controls style="width: 100%;">
                    您的浏览器不支持音频播放。
                </audio>
            </div>
        </div>
    </div>
</div>

@{
    string GetPageUrl(int page)
    {
        var routeValues = new RouteValueDictionary();
        routeValues.Add("page", page);
        
        if (filter?.StartDate.HasValue == true)
            routeValues.Add("StartDate", filter.StartDate.Value.ToString("yyyy-MM-dd"));
        if (filter?.EndDate.HasValue == true)
            routeValues.Add("EndDate", filter.EndDate.Value.ToString("yyyy-MM-dd"));
        if (!string.IsNullOrEmpty(filter?.CallerNumber))
            routeValues.Add("CallerNumber", filter.CallerNumber);
        if (!string.IsNullOrEmpty(filter?.CalleeNumber))
            routeValues.Add("CalleeNumber", filter.CalleeNumber);
            
        return Url.Action("Index", routeValues) ?? "";
    }
}

@section Scripts {
    <script>
        function refreshRecordings() {
            location.reload();
        }

        function playRecording(recordingId) {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = '@Url.Action("Play")/' + recordingId;
            $('#playModal').modal('show');
        }

        function deleteRecording(recordingId) {
            if (confirm('确定要删除这条录音记录吗？此操作不可恢复。')) {
                fetch('@Url.Action("Delete")/' + recordingId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        if (response.ok) {
                            location.reload();
                        }
                    }
                })
                .catch(error => {
                    console.error('删除录音失败:', error);
                    alert('删除录音失败');
                });
            }
        }

        // 页面加载完成后的初始化
        $(document).ready(function() {
            // 自动刷新存储信息
            setInterval(function() {
                fetch('@Url.Action("GetStorageInfo")')
                    .then(response => response.json())
                    .then(data => {
                        // 更新存储信息显示
                        updateStorageInfo(data);
                    })
                    .catch(error => console.error('获取存储信息失败:', error));
            }, 30000); // 每30秒刷新一次
        });

        function updateStorageInfo(storageInfo) {
            // 更新存储使用情况显示
            const usageText = storageInfo.usedSizeMB + ' / ' + storageInfo.totalSizeMB + ' MB';
            const usagePercentage = storageInfo.usagePercentage;
            
            $('.info-box-number').first().text(usageText);
            $('.progress-bar').css('width', usagePercentage + '%');
            $('.info-box-number').last().text(storageInfo.recordingCount);
        }
    </script>
}
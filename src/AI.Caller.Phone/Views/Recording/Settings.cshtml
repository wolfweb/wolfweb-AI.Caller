@model AI.Caller.Phone.Entities.RecordingSetting

@{
    ViewData["Title"] = "录音设置";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">录音设置</h3>
                </div>

                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @TempData["SuccessMessage"]
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>
                }

                <form asp-action="SaveSettings" method="post">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="AutoRecording" class="form-label">
                                        <i class="fas fa-microphone"></i> 自动录音
                                    </label>
                                    <div class="form-check">
                                        <input asp-for="AutoRecording" class="form-check-input" type="checkbox" />
                                        <label class="form-check-label" asp-for="AutoRecording">
                                            启用通话自动录音
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">开启后，所有通话将自动开始录音</small>
                                </div>

                                <div class="form-group">
                                    <label asp-for="AudioFormat" class="form-label">
                                        <i class="fas fa-file-audio"></i> 音频格式
                                    </label>
                                    <select asp-for="AudioFormat" class="form-control">
                                        <option value="wav">WAV (无损)</option>
                                        <option value="mp3">MP3 (压缩)</option>
                                    </select>
                                    <small class="form-text text-muted">WAV格式音质更好但文件较大，MP3格式文件较小</small>
                                </div>

                                <div class="form-group">
                                    <label asp-for="AudioQuality" class="form-label">
                                        <i class="fas fa-sliders-h"></i> 音频质量 (采样率)
                                    </label>
                                    <select asp-for="AudioQuality" class="form-control">
                                        <option value="8000">8kHz (电话质量)</option>
                                        <option value="16000">16kHz (宽带语音)</option>
                                        <option value="44100">44.1kHz (CD质量)</option>
                                        <option value="48000">48kHz (专业质量)</option>
                                    </select>
                                    <small class="form-text text-muted">更高的采样率提供更好的音质但占用更多存储空间</small>
                                </div>

                                <div class="form-group">
                                    <div class="form-check">
                                        <input asp-for="EnableCompression" class="form-check-input" type="checkbox" />
                                        <label class="form-check-label" asp-for="EnableCompression">
                                            <i class="fas fa-compress"></i> 启用音频压缩
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">压缩可以减少文件大小，但可能略微影响音质</small>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="MaxRetentionDays" class="form-label">
                                        <i class="fas fa-calendar-alt"></i> 录音保留天数
                                    </label>
                                    <input asp-for="MaxRetentionDays" class="form-control" type="number" min="1" max="365" />
                                    <small class="form-text text-muted">超过此天数的录音将被自动删除</small>
                                </div>

                                <div class="form-group">
                                    <label asp-for="MaxStorageSizeMB" class="form-label">
                                        <i class="fas fa-hdd"></i> 最大存储空间 (MB)
                                    </label>
                                    <input asp-for="MaxStorageSizeMB" class="form-control" type="number" min="100" max="10240" />
                                    <small class="form-text text-muted">录音文件占用的最大存储空间</small>
                                </div>

                                <div class="form-group">
                                    <label asp-for="StoragePath" class="form-label">
                                        <i class="fas fa-folder"></i> 存储路径
                                    </label>
                                    <input asp-for="StoragePath" class="form-control" readonly />
                                    <small class="form-text text-muted">录音文件的存储目录</small>
                                </div>

                                <!-- 存储使用情况 -->
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-chart-pie"></i> 存储使用情况
                                        </h6>
                                        <div id="storageInfo">
                                            <div class="d-flex justify-content-between">
                                                <span>已使用:</span>
                                                <span id="usedStorage">加载中...</span>
                                            </div>
                                            <div class="progress mb-2">
                                                <div id="storageProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>录音数量:</span>
                                                <span id="recordingCount">加载中...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer">
                        <div class="d-flex justify-content-between">
                            <div>
                                <a asp-action="Index" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> 返回录音列表
                                </a>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-warning" onclick="resetToDefaults()">
                                    <i class="fas fa-undo"></i> 恢复默认
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 保存设置
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 高级设置 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-cogs"></i> 高级设置
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-info btn-block" onclick="testRecording()">
                                <i class="fas fa-microphone-alt"></i> 测试录音功能
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-warning btn-block" onclick="cleanupOldRecordings()">
                                <i class="fas fa-broom"></i> 清理过期录音
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadStorageInfo();
            
            // 监听格式变化，更新质量建议
            $('#AudioFormat').change(function() {
                updateQualityRecommendation();
            });
            
            updateQualityRecommendation();
        });

        function loadStorageInfo() {
            fetch('@Url.Action("GetStorageInfo")')
                .then(response => response.json())
                .then(data => {
                    updateStorageDisplay(data);
                })
                .catch(error => {
                    console.error('获取存储信息失败:', error);
                    $('#usedStorage').text('获取失败');
                    $('#recordingCount').text('获取失败');
                });
        }

        function updateStorageDisplay(storageInfo) {
            const usedText = storageInfo.usedSizeMB + ' / ' + storageInfo.totalSizeMB + ' MB';
            const usagePercentage = storageInfo.usagePercentage;
            
            $('#usedStorage').text(usedText);
            $('#recordingCount').text(storageInfo.recordingCount);
            $('#storageProgress').css('width', usagePercentage + '%');
            
            // 根据使用率设置进度条颜色
            const progressBar = $('#storageProgress');
            progressBar.removeClass('bg-success bg-warning bg-danger');
            if (usagePercentage < 70) {
                progressBar.addClass('bg-success');
            } else if (usagePercentage < 90) {
                progressBar.addClass('bg-warning');
            } else {
                progressBar.addClass('bg-danger');
            }
        }

        function updateQualityRecommendation() {
            const format = $('#AudioFormat').val();
            const qualitySelect = $('#AudioQuality');
            
            if (format === 'mp3') {
                // MP3格式建议使用较低采样率
                if (qualitySelect.val() > 16000) {
                    qualitySelect.val('16000');
                }
            }
        }

        function resetToDefaults() {
            if (confirm('确定要恢复到默认设置吗？')) {
                $('#AutoRecording').prop('checked', true);
                $('#AudioFormat').val('wav');
                $('#AudioQuality').val('44100');
                $('#EnableCompression').prop('checked', true);
                $('#MaxRetentionDays').val('30');
                $('#MaxStorageSizeMB').val('1024');
                
                updateQualityRecommendation();
            }
        }

        function testRecording() {
            alert('录音功能测试将在后续版本中实现');
        }

        function cleanupOldRecordings() {
            if (confirm('确定要清理过期的录音文件吗？此操作不可恢复。')) {
                // 这里可以调用清理API
                fetch('@Url.Action("CleanupExpiredRecordings")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    alert('清理完成，共清理了 ' + data.count + ' 个过期录音文件');
                    loadStorageInfo(); // 重新加载存储信息
                })
                .catch(error => {
                    console.error('清理失败:', error);
                    alert('清理过期录音失败');
                });
            }
        }

        // 表单提交前验证
        $('form').submit(function(e) {
            const maxRetention = parseInt($('#MaxRetentionDays').val());
            const maxStorage = parseInt($('#MaxStorageSizeMB').val());
            
            if (maxRetention < 1 || maxRetention > 365) {
                alert('录音保留天数必须在1-365天之间');
                e.preventDefault();
                return false;
            }
            
            if (maxStorage < 100 || maxStorage > 10240) {
                alert('最大存储空间必须在100MB-10GB之间');
                e.preventDefault();
                return false;
            }
            
            return true;
        });
    </script>
}
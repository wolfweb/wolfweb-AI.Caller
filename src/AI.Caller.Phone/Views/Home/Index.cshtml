﻿﻿﻿﻿@using AI.Caller.Phone.Entities
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model IEnumerable<Contact>

@{
    ViewData["Title"] = "Phone";
}

<div class="container mt-4">
    <div class="row g-4">
        <!-- 左侧通讯录 -->
        <div class="col-lg-4">
            <div class="card modern-card">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <div class="icon-wrapper me-3">
                            <i class="bi bi-person-lines-fill"></i>
                        </div>
                        通讯录
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="contactsList">
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var contact in Model)
                            {
                                <button type="button" class="list-group-item list-group-item-action contact-item" 
                                        data-name="@contact.Name" data-phone="@contact.PhoneNumber">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-person-circle text-primary me-2"></i>
                                            <span class="contact-name">@contact.Name</span>
                                        </div>
                                        <span class="badge bg-light text-dark">@contact.PhoneNumber</span>
                                    </div>
                                </button>
                            }
                        }
                        else
                        {
                            <div class="list-group-item text-center py-5 border-0">
                                <div class="empty-state">
                                    <div class="empty-icon mb-3">
                                        <i class="bi bi-person-plus-fill"></i>
                                    </div>
                                    <h6 class="text-muted mb-3">暂无联系人</h6>
                                    <p class="text-muted small mb-3">添加联系人后即可快速拨打电话</p>
                                    <a asp-controller="Account" asp-action="AddContact" class="btn btn-primary btn-sm">
                                        <i class="bi bi-plus-circle me-1"></i> 添加联系人
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="card-footer text-center">
                    <a asp-controller="Account" asp-action="ManageContacts" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-gear"></i> 管理通讯录
                    </a>
                </div>
            </div>
        </div>

        <!-- 右侧拨号器 -->
        <div class="col-lg-8">
            <div class="card modern-card">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <div class="icon-wrapper me-3">
                            <i class="bi bi-telephone"></i>
                        </div>
                        智能拨号器
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 音频元素 -->
                    <audio id="remoteAudio" autoplay class="d-none"></audio>
                    
                    <!-- 显示当前状态 -->
                    <div class="alert mb-4" id="statusAlert">
                        <span id="status">未连接</span>
                    </div>
                    
                    <!-- 录音状态指示器 -->
                    <div class="alert alert-success mb-4" id="recordingStatusAlert">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-record-circle-fill text-success me-2" id="recordingIcon"></i>
                            <span id="recordingStatus">录音状态</span>
                            <span class="badge bg-success ms-auto" id="recordingTimer">待机中</span>
                        </div>
                    </div>
                    
                    <!-- 输入框和拨号按钮 -->
                    <div class="input-group mb-4">
                        <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                        <input type="text" id="destination" class="form-control form-control-lg" 
                               placeholder="输入电话号码或选择联系人" />
                        <button id="callButton" class="btn btn-success">
                            <i class="bi bi-telephone-fill"></i> 拨打
                        </button>
                        <button id="answerButton" class="btn btn-primary d-none">
                            <i class="bi bi-telephone-inbound-fill"></i> 接听
                        </button>
                        <button id="hangupButton" class="btn btn-danger d-none">
                            <i class="bi bi-telephone-x-fill"></i> 挂断
                        </button>
                        @if (User.HasClaim("isAdmin", "True")) {
                            <button id="pauseRecordingButton" class="btn btn-warning d-none">
                                <i class="bi bi-pause-circle"></i> 暂停录音
                            </button>
                            <button id="resumeRecordingButton" class="btn btn-success d-none">
                                <i class="bi bi-play-circle"></i> 恢复录音
                            </button>
                        }
                    </div>
                    
                    <!-- 拨号盘 -->
                    <div class="dialpad mb-3">
                        <div class="row g-2 mb-2">
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="1">1</button></div>
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="2">2</button></div>
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="3">3</button></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="4">4</button></div>
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="5">5</button></div>
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="6">6</button></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="7">7</button></div>
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="8">8</button></div>
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="9">9</button></div>
                        </div>
                        <div class="row g-2">
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="*">*</button></div>
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="0">0</button></div>
                            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="#">#</button></div>
                        </div>
                    </div>
                    
                    <!-- 通话信息 -->
                    <div class="call-info d-none" id="callInfo">
                        <div class="text-center mb-3">
                            <div class="display-1 text-primary">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            <h3 id="callerName">未知联系人</h3>
                            <p id="callerNumber" class="text-muted"></p>
                        </div>
                        <div class="d-flex justify-content-center">
                            <div id="callTimer" class="badge bg-success p-2 fs-6">00:00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="~/js/ui-integration.js"></script>
    <script src="~/js/error-recovery.js"></script>
    <script src="~/js/hangup-handler.js"></script>
    
    <script src="~/js/call-state-manager.js"></script>
    <script src="~/js/ui-manager.js"></script>
    <script src="~/js/webrtc-manager.js"></script>
    <script src="~/js/signalr-manager.js"></script>
    <script src="~/js/simple-recording-manager.js"></script>
    <script src="~/js/phone-app.js"></script>
    
    <script>
        // 全局变量初始化
        window.isRecording = false;
        window.isAutoRecording = false;
        window.callTimerInterval = null;
        window.callStartTime = null;
        window.recordingTimerInterval = null;
        window.recordingStartTime = null;

        // 初始化电话应用
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                window.phoneApp = new PhoneApp();
                await window.phoneApp.initialize();
                console.log('电话应用启动成功');
            } catch (error) {
                console.error('电话应用启动失败:', error);
            }
        });
    </script>
}